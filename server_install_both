# Libs and apps
dpkg --add-architecture i386
apt-get update -y && apt-get upgrade -y
apt-get install -y libc6:i386
apt-get install -y lib32gcc1
apt-get install -y lib32z1
apt-get install -y git

# Install steam and L4D2
wget http://media.steampowered.com/installer/steamcmd_linux.tar.gz
tar -xvzf steamcmd_linux.tar.gz
chmod -R 777 .
./steamcmd.sh << UNIFIX
login anonymous
force_install_dir ./server
app_update 222860 validate
quit
UNIFIX

./steamcmd.sh << UNIFIXT1
login anonymous
force_install_dir ./serverT1
app_update 222860 validate
quit
UNIFIXT1

# Server download
git clone https://github.com/misdocumeno/Unifix
cp -r Unifix/* server/left4dead2/

# Server T1 download
git clone https://github.com/misdocumeno/Unifix_T1
cp -r Unifix_T1/* serverT1/left4dead2/

# Screen script
printf 'screen -S Unifix ./server/srcds_run -tickrate 100 +map "c10m1_caves" +sv_clockcorrection_msecs 15 -timeout 10 +ip 0.0.0.0 -port 27015 +precache_all_survivors 1' > server_start
chmod u+x server_start

# Screen T1 script
printf 'screen -S Unifix_T1 ./serverT1/srcds_run -tickrate 100 +map "c10m1_caves" +sv_clockcorrection_msecs 15 -timeout 10 +ip 0.0.0.0 -port 27016 +precache_all_survivors 1' > server_startT1
chmod u+x server_startT1

# Per server config backup
# Edit these files instead of the server ones
# This will be copied to the server directory when update
mkdir -p serverconfigs/cfg/
cp Unifix/cfg/server.cfg serverconfigs/cfg/
mkdir -p serverconfigs/addons/sourcemod/configs/sourcebans/
cp Unifix/addons/sourcemod/configs/sourcebans/sourcebans.cfg serverconfigs/addons/sourcemod/configs/sourcebans/
cp Unifix/addons/sourcemod/configs/databases.cfg serverconfigs/addons/sourcemod/configs/
mkdir -p serverconfigsT1/cfg/
cp Unifix_T1/cfg/server.cfg serverconfigsT1/cfg/
mkdir -p serverconfigsT1/addons/sourcemod/configs/sourcebans/
cp Unifix_T1/addons/sourcemod/configs/sourcebans/sourcebans.cfg serverconfigsT1/addons/sourcemod/configs/sourcebans/
cp Unifix_T1/addons/sourcemod/configs/databases.cfg serverconfigsT1/addons/sourcemod/configs/

# Update script
printf '%s\n' \
'killall screen' \
'cd Unifix' \
'git pull' \
'rm -rf ../server/left4dead2/addons/sourcemod/' \
'rm -rf ../server/left4dead2/cfg/sourcemod/' \
'rm -rf ../server/left4dead2/cfg/cfgogl/' \
'rm ../server/left4dead2/cfg/generalfixes.cfg' \
'rm ../server/left4dead2/cfg/sharedplugins.cfg' \
'rm ../server/left4dead2/cfg/server.cfg' \
'rm ../server/left4dead2/host.txt' \
'rm ../server/left4dead2/motd.txt' \
'cp -r * ../server/left4dead2/' \
'git reset HEAD --hard' \
'cd ..' \
'cd serverconfigs' \
'cp -r * ../server/left4dead2/' \
'cd ..' \
'chmod -R 777 server' \
> server_update
chmod u+x server_update

# Update T1 script
printf '%s\n' \
'killall screen' \
'cd Unifix_T1' \
'git pull' \
'rm -rf ../serverT1/left4dead2/addons/sourcemod/' \
'rm -rf ../serverT1/left4dead2/cfg/sourcemod/' \
'rm ../serverT1/left4dead2/cfg/t1.cfg' \
'rm ../serverT1/left4dead2/cfg/server.cfg' \
'rm ../serverT1/left4dead2/host.txt' \
'rm ../serverT1/left4dead2/motd.txt' \
'cp -r * ../serverT1/left4dead2/' \
'git reset HEAD --hard' \
'cd ..' \
'cd serverconfigsT1' \
'cp -r * ../serverT1/left4dead2/' \
'cd ..' \
'chmod -R 777 serverT1' \
> server_updateT1
chmod u+x server_updateT1

chmod -R 777 server
chmod -R 777 serverT1